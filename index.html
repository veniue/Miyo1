<!DOCTYPE html>
<html lang="zh-CN">
<head>
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <title>AI 角色聊天 — 最终修正版</title>
    <style>
        :root{
            --border-color: #e0e0e0;
            --background-color: #fff;
            --text-color: #000;
            --placeholder-color: #bbb;
            --active-color: #000;
            --grey-bg: #f8f8f8;
            --button-bg: #5f5f5f;
            --button-text: #fff;
        }

        html,body{
            height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color:#e0e0e0; display:flex; align-items:center; justify-content:center;
            overflow: hidden;
        }

        .phone-container{
            height:100vh;
            max-height:1000px;
            width:min(calc(95vh * 812 / 812), 420px);
            max-width:99.9vw;
            border:8px solid #333;
            border-radius:28px;
            box-shadow:0 10px 30px rgba(0,0,0,0.25);
            background-color:var(--background-color);
            display:flex; flex-direction:column; overflow:hidden; position:relative;
        }

        .status-bar{
            display:flex; justify-content:space-between; align-items:center; padding: 10px 16px; font-size:12px;
            flex-shrink:0; background:var(--background-color); z-index:400;
            padding-top: calc(env(safe-area-inset-top, 0px) + 10px);
        }
        .status-bar .time{ font-weight:700;}
        .status-bar .battery-icon {
            width: 28px; height: 28px; background-image: url('https://i.postimg.cc/44MgY7kN/IMG-9486.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }

        .app-view{ flex:1; position:relative; display:flex; flex-direction:column; overflow:hidden; }

        #main-content, #chat-window, #more-options-page {
            position:absolute; inset:0; display:flex; flex-direction:column; width:100%; height:100%;
            background:var(--background-color); transition: transform 0.3s ease-in-out;
        }

        #chat-window, #more-options-page { display: none; z-index:200; background: #f7f7f7; }
        #more-options-page { z-index: 250; transform: translateX(100%); }
        #more-options-page.active { transform: translateX(0); display:flex; }

        .main-header, #chat-header, .more-options-header-page {
            flex-shrink:0; background:var(--background-color); border-bottom:1px solid #eee; padding: 8px 16px 8px 10px;
            display:flex; align-items:center; justify-content:space-between;
        }
        .main-header { position: relative; justify-content: center; }
        #header-title { font-size: 18px; font-weight: bold; text-align: center; }
        #add-contact-btn { position: absolute; right: 16px; font-size: 20px; cursor: pointer; }

        .content{ flex:1; overflow:auto; background:var(--background-color); box-sizing:border-box; }
        .page{ display:none; height:100%; box-sizing:border-box; }
        .page.active{ display:block; }

        .bottom-nav{ display:flex; justify-content:space-around; border-top:1px solid #ddd; padding:8px 0; background:#fafafa; flex-shrink:0; padding-bottom: calc(env(safe-area-inset-bottom, 8px)); }
        .bottom-nav img { width: 24px; height: 24px; margin-bottom: 2px; }
        .nav-item{ display:flex; flex-direction:column; align-items:center; cursor:pointer; color:#888; font-size:12px; }
        .nav-item.active{ color:var(--active-color); }

        .message-list, .contact-list{ list-style:none; padding:0; margin:0; }
        .message-item, .contact-item{ display:flex; padding:10px 16px; border-bottom:1px solid #f0f0f0; cursor:pointer; align-items: center; }
        .avatar-display { width:48px; height:48px; border-radius:50%; background-color:#ccc; margin-right:12px; flex-shrink:0; background-size: cover; background-position: center; border: 1px solid #eee; }
        .settings-avatar-display { width: 68px; height: 68px; }
        .form-avatar-placeholder { cursor: pointer; margin: 0 auto; width: 68px; height: 68px; border-radius:50%; background-color:#ccc; border: 1px solid #eee; background-size: cover; background-position: center; }

        .message-item .details, .contact-item .details { overflow:hidden; }
        .message-item .last-message{ color:#666; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:170px; }

        #chat-header-left{ display:flex; align-items:center; gap:10px; }
        #back-btn, .back-btn-page { background:none; border:0; font-size:20px; cursor:pointer; padding:6px; color: black; }
        #chat-title { font-weight:600; font-size:16px; }
        #chat-title.typing { font-size: 13px; color: #888; font-style: italic; }

        #chat-messages{ flex:1; padding:12px 14px 10px; overflow-y:auto; display:flex; flex-direction:column; gap:14px; -webkit-overflow-scrolling:touch; box-sizing:border-box; padding-bottom: 100px; }
        .message-wrapper { display: flex; max-width: 85%; align-items: flex-start; gap: 8px; }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; background-size: cover; background-position: center; }
        .message-bubble{ max-width: 100%; padding:8px 12px; border-radius:12px; word-break:break-word; line-height:1.5; background: rgba(255, 255, 255, 0.8); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        .message-wrapper.sent { align-self: flex-end; flex-direction: row-reverse; }
        .message-wrapper.received { align-self: flex-start; }
        .message-bubble.sticker { background: transparent; padding: 0; box-shadow: none; }
        .message-bubble.sticker img { max-width: 120px; display: block; height: auto; }
        .message-bubble.error{ background:#ffebee; color:#c62828; }

        *, *::before, *::after { box-sizing: border-box; }

        #chat-input-area {
            flex-shrink: 0; display: flex; align-items: center; gap: 4px; padding: 8px;
            padding-bottom: calc(env(safe-area-inset-bottom, 8px));
            border-top: 1px solid #e6e6e6; background: #fff; z-index: 50;
        }
        #chat-input { flex: 1 1 auto; min-width: 0; padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; outline: none; }
        .chat-icon-btn, #more-options-btn {
            flex: 0 0 auto; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;
            border: none; background: none; cursor: pointer; padding: 4px; border-radius: 6px; color: black;
            background-size: 24px 24px; background-repeat: no-repeat; background-position: center;
        }

        #tools-btn {background-image: url('https://i.postimg.cc/zXLmCJSf/IMG-9471.png');}
        #emoji-btn { background-image: url('https://i.postimg.cc/4NjDwrBH/IMG-9474.png');}
        #ai-reply-btn { background-image: url('https://i.postimg.cc/C1CNfMN1/IMG-9490.png'); }
        #send-btn { background-image: url('https://i.postimg.cc/jdBpvGZW/IMG-9472.png');}

        #more-options-btn { font-size: 20px; width: 40px; height: 40px; }

        .more-options-content { flex: 1; padding: 18px; background-color: var(--grey-bg); }
        .options-group { background-color: white; border-radius: 10px; margin-bottom: 12px; overflow: hidden; }
        .options-item { padding: 14px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .options-item:last-child { border-bottom: none; }
        .options-item:hover { background: #fafafa; }

        #popup-layer { position: absolute; inset: 0; z-index: 500; pointer-events: none; transition: background-color .25s ease; }
        #popup-layer.active { pointer-events: auto; background-color: rgba(0, 0, 0, 0.4); }
        .modal { display: none; position: absolute; left: 0; bottom: 0; width: 100%; max-width: 100%; max-height: 95%; background-color: var(--grey-bg); border-radius: 16px 16px 0 0; box-shadow: 0 -8px 25px rgba(0,0,0,0.15); opacity: 0; transform: translateY(100%); transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal.open { display: flex; opacity: 1; transform: translateY(0); }
        .modal-body-container { display: flex; flex-direction: column; max-height: 85vh; width: 100%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; font-weight: 600; font-size: 16px; flex-shrink: 0; }
        .modal-body { padding: 0 18px 18px; overflow-y: auto; }
        .modal-footer { display:flex; flex-direction: column; gap: 8px; padding: 18px; border-top: 1px solid #e0e0e0; flex-shrink: 0; }
        .modal-footer .form-button-group { display: flex; gap: 8px; }
        .form-button { width:100%; padding:10px; border-radius:8px; border:0; background:var(--button-bg); color:var(--button-text); cursor:pointer; margin: 0; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: var(--background-color); outline: none; font-size: 14px; }
        .form-group textarea { height: 110px; resize: vertical; }

        #chat-tools-popup { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 12px); }
        .tools-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:14px; padding:12px; }
        .tool-item{ display:flex; flex-direction:column; align-items:center; gap:8px; cursor:pointer; font-size: 12px; }
        .tool-icon{ width:56px; height:56px; background-color:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 4px rgba(0,0,0,0.06); background-size: 32px 32px; background-repeat: no-repeat; background-position: center; }

        .icon-image { background-image: url('https://i.postimg.cc/zBsgBDJr/IMG-9480.png'); }
        .icon-gift { background-image: url('https://i.postimg.cc/Y0Qmmc9p/IMG-9481.png'); }
        .icon-phone { background-image: url('https://i.postimg.cc/RhwnnrFS/IMG-9482.png'); }
        .icon-share { background-image: url('https://i.postimg.cc/MH1jjkTw/IMG-9483.png');}
        .icon-transfer { background-image: url('https://i.postimg.cc/NFRrrhMQ/IMG-9484.png');}


        #emoji-picker-modal { background: #f7f7f7; }
        #emoji-picker-container { height: 45vh; display: flex; flex-direction: column; }
        .emoji-picker-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background: #fdfdfd; border-radius: 16px 16px 0 0; }
        .emoji-add-options { display: flex; align-items: center; gap: 8px; }
        .emoji-add-options button, .emoji-add-options label { padding: 5px 14px; border: none; background-color: #e9e9e9; border-radius: 15px; font-size: 13px; cursor: pointer; line-height: 1.5; color: #555; }
        #emoji-grid-container { flex: 1; overflow-y: auto; background-color: #f7f7f7; }
        #emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; padding: 16px; }
        .sticker-item-wrapper { position: relative; }
        .sticker-item { width: 100%; height: 80px; object-fit: contain; cursor: pointer; background: rgba(255,255,255,0.7); border-radius: 8px; padding: 5px; }
        .delete-emoji-btn { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: #ff4d4d; color: white; border: none; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .close-btn { border:0;background:none;font-size:20px;cursor:pointer; padding: 4px; color: #888; }
        .empty-state{ text-align:center; color:var(--placeholder-color); padding: 40px 20px; }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="status-bar"><span id="current-time"></span><div class="battery-icon"></div></div>

        <div class="app-view">
            <div id="main-content">
                 <div class="main-header"><div id="header-title">消息</div><div id="add-contact-btn" data-modal-open="add-contact-modal" style="display:none;">＋</div></div>
                <div class="content">
                    <div id="messages-page" class="page active"><ul id="message-list" class="message-list"></ul><div id="messages-empty" class="empty-state">没有消息</div></div>
                    <div id="contacts-page" class="page"><ul id="contact-list" class="contact-list"></ul><div id="contacts-empty" class="empty-state">轻点右上角 '+' 添加角色</div></div>
                    <div id="settings-page" class="page">
                        <div style="padding:18px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div class="avatar-display settings-avatar-display" id="user-avatar-display"></div>
                                <div><div id="settings-nickname-display" style="font-weight:700;">我的昵称</div></div>
                            </div>
                            <div style="margin-top:18px;">
                                <div style="padding:12px;border-top:1px solid #eee;cursor:pointer;" data-modal-open="user-display-modal">我的 &gt;</div>
                                <div style="padding:12px;border-top:1px solid #eee;cursor:pointer;">钱包 &gt;</div>
                                <div style="padding:12px;border-top:1px solid #eee;cursor:pointer;" data-modal-open="api-settings-modal">API 设置 &gt;</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bottom-nav"><div class="nav-item active" data-page="messages-page"><img src="https://i.postimg.cc/430xWGfg/IMG-9457.png" alt="消息"><span>消息</span></div><div class="nav-item" data-page="contacts-page"><img src="https://i.postimg.cc/fL0TFPyV/IMG-9458.png" alt="联系人"><span>联系人</span></div><div class="nav-item" data-page="settings-page"><img src="https://i.postimg.cc/k4tXZHGV/IMG-9459.png" alt="设置"><span>设置</span></div></div>
            </div>

            <div id="chat-window" aria-hidden="true">
                 <div id="chat-header"><div id="chat-header-left"><button id="back-btn">&lt;</button><div id="chat-title">角色名称</div></div><button id="more-options-btn">⋯</button></div>
                <div id="chat-messages" role="log" aria-live="polite"></div>
                 <div id="chat-input-area" role="region" aria-label="消息输入">
                  <div style="display:flex; gap: 4px;">
                    <button class="chat-icon-btn" id="tools-btn" data-modal-open="chat-tools-popup" title="工具"></button>
                    <button class="chat-icon-btn" id="emoji-btn" data-modal-open="emoji-picker-modal" title="表情"></button>
                  </div>
                  <input id="chat-input" type="text" placeholder="输入消息..." autocomplete="off" />
                  <div style="display:flex; gap: 4px;">
                    <button class="chat-icon-btn" id="ai-reply-btn" title="请求回复"></button>
                    <button class="chat-icon-btn" id="send-btn" title="发送"></button>
                  </div>
                </div>
            </div>

            <div id="more-options-page" aria-hidden="true">
                <div class="more-options-header-page"><button class="back-btn-page" id="back-from-more-options">&lt;</button><div style="font-weight:600;font-size:16px;">聊天详情</div><div style="width: 40px;"></div></div>
                <div class="more-options-content"><div class="options-group"><div class="options-item" id="modify-character-btn" data-modal-open="add-contact-modal"><span>修改角色设定</span><span>&gt;</span></div><div class="options-item" id="modify-user-btn" data-modal-open="user-settings-modal"><span>修改用户设定</span><span>&gt;</span></div></div><div class="options-group"><div class="options-item" id="export-chat-btn">导出聊天记录</div><div class="options-item" id="clear-chat-btn"><span>清除所有聊天数据</span></div><div class="options-item"><span>以现实时间为准</span><label style="display:inline-block"><input type="checkbox" id="real-time-toggle"></label></div></div></div>
            </div>

            <div id="popup-layer" aria-hidden="true" role="region">
                <div id="add-contact-modal" class="modal" role="dialog" aria-labelledby="contact-modal-title"><div class="modal-body-container"><div class="modal-header"><h3 id="contact-modal-title">创建新角色</h3><button class="close-btn" data-modal-close>×</button></div><div class="modal-body"><div class="form-avatar-placeholder" data-avatar-target-type="contact"></div><div class="form-group"><input id="contact-name" placeholder="角色名称"></div><div class="form-group"><label for="contact-prompt">角色人物设定：</label><textarea id="contact-prompt"></textarea></div></div><div class="modal-footer"><div class="form-button-group"><button class="form-button cancel" data-modal-close>返回</button><button id="save-contact-btn" class="form-button">保存角色</button></div></div></div></div>

                <div id="user-settings-modal" class="modal" role="dialog" aria-labelledby="user-settings-title"><div class="modal-body-container"><div class="modal-header"><h3 id="user-settings-title">修改用户设定</h3><button class="close-btn" data-modal-close>×</button></div><div class="modal-body"><div class="form-avatar-placeholder" data-avatar-target-type="user-settings"></div><div class="form-group"><input id="user-name" placeholder="你的昵称"></div><div class="form-group"><label for="user-prompt">你的设定：</label><textarea id="user-prompt"></textarea></div></div><div class="modal-footer"><div class="form-button-group"><button class="form-button cancel" data-modal-close>返回</button><button id="save-user-settings-btn" class="form-button">保存设定</button></div></div></div></div>

                <div id="user-display-modal" class="modal" role="dialog" aria-labelledby="user-display-title"><div class="modal-body-container"><div class="modal-header"><h3 id="user-display-title">我的</h3><button class="close-btn" data-modal-close>×</button></div><div class="modal-body"><div class="form-avatar-placeholder" data-avatar-target-type="user-display"></div><div class="form-group"><input id="display-user-name" placeholder="你的昵称"></div><div class="form-group"><label for="display-user-prompt">关于我：</label><textarea id="display-user-prompt"></textarea></div></div><div class="modal-footer"><div class="form-button-group"><button class="form-button cancel" data-modal-close>返回</button><button id="save-user-display-btn" class="form-button">保存</button></div></div></div></div>

                <div id="api-settings-modal" class="modal" role="dialog" aria-labelledby="api-settings-title"><div class="modal-body-container"><div class="modal-header"><h3 id="api-settings-title">API 设置</h3><button class="close-btn" data-modal-close>×</button></div><div class="modal-body"><div class="form-group"><label for="proxy-url">反代地址</label><input id="proxy-url" placeholder="例如: https://api.openai.com"></div><div class="form-group"><label for="api-key">API 密钥</label><input id="api-key" type="password"></div><div class="form-group"><label for="model-name">模型</label><select id="model-name"><option>请先拉取模型</option></select></div></div><div class="modal-footer"><div class="form-button-group"><button id="fetch-models-btn" class="form-button">拉取模型</button><button id="save-api-btn" class="form-button">保存设置</button></div></div></div></div>

                <div id="add-emoji-modal" class="modal" role="dialog"><div class="modal-body-container"><div class="modal-header"><h3>添加表情</h3><button class="close-btn" data-modal-close>×</button></div><div class="modal-body"><div class="form-group"><label for="emoji-url-input">表情链接 (URL)</label><input id="emoji-url-input" type="text" placeholder="粘贴图片链接"></div><div class="form-group"><label for="emoji-desc-input">表情描述</label><input id="emoji-desc-input" type="text" placeholder="输入表情的含义，如“开心”"></div></div><div class="modal-footer"><div class="form-button-group"><button id="save-emoji-btn" class="form-button">保存</button></div></div></div></div>

                <div id="avatar-settings-modal" class="modal" role="dialog" aria-labelledby="avatar-settings-title"><div class="modal-body-container"><div class="modal-header"><h3 id="avatar-settings-title">设置头像</h3><button class="close-btn" data-modal-close>×</button></div><div class="modal-body"><div class="form-group"><label for="avatar-url-input">使用链接</label><input id="avatar-url-input" type="text" placeholder="粘贴图片链接地址"></div><div style="text-align: center; margin: 10px 0; color: #888;">或</div><div class="form-group"><label class="form-button" for="avatar-file-input" style="text-align: center; padding: 10px 0;">从本地上传</label><input type="file" id="avatar-file-input" accept="image/*" style="display:none;"></div></div><div class="modal-footer"><div class="form-button-group"><button id="save-avatar-btn" class="form-button">保存头像</button></div></div></div></div>
                <div id="chat-tools-popup" class="modal" role="dialog"><div class="modal-body-container"><div style="display:flex;justify-content:flex-end; padding: 8px 8px 0;"><button class="close-btn" data-modal-close>×</button></div><div class="tools-grid"><div class="tool-item"><div class="tool-icon icon-image"></div><span>图片</span></div><div class="tool-item"><div class="tool-icon icon-gift"></div><span>礼物</span></div><div class="tool-item"><div class="tool-icon icon-phone"></div><span>电话</span></div><div class="tool-item"><div class="tool-icon icon-share"></div><span>分享</span></div><div class="tool-item"><div class="tool-icon icon-transfer"></div><span>转账</span></div></div></div></div>

                 <div id="emoji-picker-modal" class="modal" role="dialog"><div id="emoji-picker-container" class="modal-body-container"><div class="emoji-picker-header"><div class="emoji-add-options"><button data-modal-open="add-emoji-modal">URL 添加</button><label for="add-emoji-local-input">本地添加</label><input type="file" id="add-emoji-local-input" accept="image/*" style="display:none;"></div><button class="close-btn" data-modal-close>×</button></div><div id="emoji-grid-container"><div id="emoji-grid"></div><div id="emoji-empty-state" class="empty-state" style="display:none;">请先添加表情包</div></div></div></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const VERSION = 'aiChatAppState_v22'; // 妈妈又更新了版本号哦
        const defaultState = {
            contacts: [], apiConfig: { proxyUrl: '', apiKey: '', model: '' },
            userProfile: { name: '默认用户昵称', prompt: '', avatar: '' },
            userDisplay: { name: '我的昵称', prompt: '', avatar: '' },
            chats: {}, emojis: []
        };
        let state = JSON.parse(JSON.stringify(defaultState));
        let currentChatContactId = null, editingContactId = null, originalChatTitle = '';
        let avatarTarget = { type: null, id: null };
        let isGenerating = false;

        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);
        const popupLayer = $('#popup-layer');

        // --- ⬇⬇⬇ 新增 (用于逐条回复) ⬇⬇⬇ ---
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        // --- ⬆⬆⬆ 新增 ⬆⬆⬆ ---

        function updateTime() {
            $('#current-time').textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        updateTime();
        setInterval(updateTime, 60000);

        function safeParseJSON(str, fallback) {
            try { return JSON.parse(str); } catch (e) { return fallback; }
        }

        async function loadState() {
            const savedState = await localforage.getItem(VERSION); 
            const loadedState = savedState || {};
            state = { ...defaultState, ...loadedState };

            Object.keys(defaultState).forEach(key => {
                if (typeof defaultState[key] === 'object' && !Array.isArray(defaultState[key]) && defaultState[key] !== null) {
                    state[key] = { ...defaultState[key], ...loadedState[key] };
                }
            });
            
            state.contacts.forEach(c => { if (!state.chats[c.id]) { state.chats[c.id] = []; }});

            $('#proxy-url').value = state.apiConfig.proxyUrl || '';
            $('#api-key').value = state.apiConfig.apiKey || '';
            
            const modelSelect = $('#model-name');
            modelSelect.innerHTML = state.apiConfig.model ? `<option selected>${state.apiConfig.model}</option>` : '<option>请先拉取模型</option>';

            rerenderUI();
            updateEmptyStates();
        }

        async function saveState() {
            try {
                await localforage.setItem(VERSION, state); 
                return true;
            } catch (e) {
                console.warn('IndexedDB 保存失败', e);
                alert('数据保存失败，存储出现问题。');
                return false;
            }
        }

        function extractUrlFromBackground(bgStr) {
            if (!bgStr) return '';
            const match = bgStr.match(/url\("?(.*?)"?\)/);
            return match ? match[1] : '';
        }
        function updateEmptyStates(){
            $('#contacts-empty').style.display = state.contacts.length === 0 ? 'block' : 'none';
            $('#messages-empty').style.display = Object.values(state.chats).every(c => c.length === 0) ? 'block' : 'none';
        }
        function openModal(modalId) {
            const modal = $(`#${modalId}`); if (!modal) return;
            popupLayer.classList.add('active'); modal.classList.add('open');
            if (modalId === 'add-contact-modal') prepareAddContactModal();
            else if (modalId === 'user-settings-modal') prepareUserSettingsModal();
            else if (modalId === 'user-display-modal') prepareUserDisplayModal();
            else if (modalId === 'emoji-picker-modal') renderEmojis();
            else if (modalId === 'add-emoji-modal') { $('#emoji-url-input').value = ''; $('#emoji-desc-input').value = ''; }
        }
        function closeModal(modal) {
            if (!modal) return;
            modal.classList.remove('open');
            if (!popupLayer.querySelector('.modal.open')) { popupLayer.classList.remove('active'); }
        }
        document.body.addEventListener('click', e => {
            const openTrigger = e.target.closest('[data-modal-open]');
            if (openTrigger) {
                const modalId = openTrigger.getAttribute('data-modal-open');
                editingContactId = (modalId === 'add-contact-modal' && openTrigger.id === 'modify-character-btn') ? currentChatContactId : null;
                openModal(modalId); return;
            }
            const avatarTrigger = e.target.closest('.form-avatar-placeholder');
            if (avatarTrigger) {
                avatarTarget.type = avatarTrigger.dataset.avatarTargetType;
                avatarTarget.id = (avatarTarget.type === 'contact') ? editingContactId : null;
                openModal('avatar-settings-modal'); return;
            }
            const closeTrigger = e.target.closest('[data-modal-close], .cancel');
            if (closeTrigger) { closeModal(closeTrigger.closest('.modal')); return; }
            if (e.target === popupLayer) {
                const openModals = $$('.modal.open');
                if (openModals.length > 0) closeModal(openModals[openModals.length - 1]);
            }
        });
        function escapeHtml(str) { return String(str || '').replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[s]); }

        function renderEmojis() {
            const grid = $('#emoji-grid'); grid.innerHTML = '';
            $('#emoji-empty-state').style.display = state.emojis.length ? 'none' : 'block';
            state.emojis.forEach(emoji => {
                const wrapper = document.createElement('div'); wrapper.className = 'sticker-item-wrapper';
                wrapper.innerHTML = `<img src="${emoji.url}" class="sticker-item" title="${escapeHtml(emoji.desc)}"><button class="delete-emoji-btn">&times;</button>`;
                wrapper.querySelector('.sticker-item').onclick = () => { sendSticker(emoji); closeModal($('#emoji-picker-modal')); };
                wrapper.querySelector('.delete-emoji-btn').onclick = (ev) => { ev.stopPropagation(); if (confirm('确定删除此表情？')) deleteEmoji(emoji.url); };
                grid.appendChild(wrapper);
            });
        }
        
        async function addEmoji(url, desc) {
            if (!url || !desc) return;
            if (state.emojis.some(e => e.url.slice(0, 50) === url.slice(0, 50))) return;
            
            state.emojis.unshift({ url, desc });
            
            if (!(await saveState())) { 
                state.emojis.shift(); 
            } else {
                renderEmojis();
            }
        }

        async function deleteEmoji(url) { 
            state.emojis = state.emojis.filter(e => e.url !== url); 
            await saveState(); 
            renderEmojis(); 
        }

        $('#save-emoji-btn').onclick = async () => {
            const url = $('#emoji-url-input').value.trim(); const desc = $('#emoji-desc-input').value.trim();
            if (url && desc) { 
                await addEmoji(url, desc); 
                closeModal($('#add-emoji-modal')); 
            } else { 
                alert('必须提供链接和描述！'); 
            }
        };
        
        $('#add-emoji-local-input').onchange = async e => {
            const file = e.target.files?.[0];
            if (file) {
                const desc = prompt('请输入此表情的描述：');
                e.target.value = ''; 
                if (!desc) return;
                try {
                    const dataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    await addEmoji(dataUrl, desc); 
                } catch (err) { console.error("Emoji读取失败", err); alert("图片处理失败。"); }
            }
        };

        async function updateAvatar(url) {
            const { type, id } = avatarTarget;
            
            const oldValue =
                type === 'user-settings' ? state.userProfile.avatar :
                type === 'user-display' ? state.userDisplay.avatar :
                (type === 'contact' && id) ? (state.contacts.find(c=>c.id===id) || {}).avatar : null;

            if (type === 'user-settings') state.userProfile.avatar = url;
            else if (type === 'user-display') state.userDisplay.avatar = url;
            else if (type === 'contact' && id) { const c = state.contacts.find(c => c.id === id); if (c) c.avatar = url; }

            if (!(await saveState())) { 
                if (type === 'user-settings') state.userProfile.avatar = oldValue;
                else if (type === 'user-display') state.userDisplay.avatar = oldValue;
                else if (type === 'contact' && id) { const c = state.contacts.find(c => c.id === id); if (c) c.avatar = oldValue; }
                 return; 
            }

            const placeholder = document.querySelector(`.modal.open .form-avatar-placeholder[data-avatar-target-type="${type}"]`);
            if (placeholder) placeholder.style.backgroundImage = `url("${url}")`;
            rerenderUI();
        }

        $('#save-avatar-btn').onclick = async () => {
            const url = $('#avatar-url-input').value.trim();
            if (url) await updateAvatar(url); 
            $('#avatar-url-input').value = ''; closeModal($('#avatar-settings-modal'));
        };
        
        $('#avatar-file-input').onchange = async e => {
            const file = e.target.files?.[0];
            if (file) {
                closeModal($('#avatar-settings-modal'));
                try {
                    const dataUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    await updateAvatar(dataUrl);
                } catch (err) {
                    console.error("头像读取失败", err);
                    alert("图片处理失败，请重试。");
                } finally {
                   e.target.value = '';
                }
            }
        };

        async function sendSticker(emoji) { await sendChatMessage(emoji.url, 'sticker', emoji.desc); } 
        async function sendMessage() { const text = $('#chat-input').value.trim(); if(text) await sendChatMessage(text, 'text'); } 
        
        async function sendChatMessage(content, type, desc = '') {
            if (!currentChatContactId) return;
            if (type === 'text') $('#chat-input').value = '';

            const messageData = { sender: 'user', text: content, timestamp: Date.now(), type, desc };
            state.chats[currentChatContactId].push(messageData);
            if(!(await saveState())){ 
                state.chats[currentChatContactId].pop(); 
                return;
            }
            appendMessage(messageData);
            renderMessageList();
        }

        async function receiveChatMessage(content, type = 'text', desc = '') {
            if (!currentChatContactId) return;
            
            const messageData = { 
                sender: 'assistant', 
                text: content, 
                timestamp: Date.now(), 
                type, 
                desc 
            };
            
            state.chats[currentChatContactId].push(messageData);
            if(!(await saveState())){ 
                state.chats[currentChatContactId].pop(); 
                return;
            }
            appendMessage(messageData);
            renderMessageList();
        }

        function renderContacts() { /* ... */ }
        function renderMessageList() { /* ... */ }
        function prepareAddContactModal() { /* ... */ }
        function prepareUserSettingsModal() { /* ... */ }
        function prepareUserDisplayModal() { /* ... */ }
        function appendMessage(msg) { /* ... */ }
        function switchPage(pageId) { /* ... */ }
        function openChat(contactId) { /* ... */ }

        function setupEventListeners() {
            $$('.nav-item').forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));
            $('#send-btn').addEventListener('click', sendMessage);
            $('#chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
            $('#ai-reply-btn').addEventListener('click', triggerAiReply);
            $('#back-btn').addEventListener('click', () => {
                $('#main-content').style.display = 'flex'; $('#chat-window').style.display = 'none';
                $('#more-options-page').classList.remove('active'); currentChatContactId = null; rerenderUI();
            });
            $('#more-options-btn').addEventListener('click', () => $('#more-options-page').classList.add('active'));
            $('#back-from-more-options').addEventListener('click', () => $('#more-options-page').classList.remove('active'));

            $('#save-contact-btn').addEventListener('click', async () => { 
                const name = $('#contact-name').value.trim(); if (!name) { alert('角色名称不能为空'); return; }
                const prompt = $('#contact-prompt').value.trim();
                const avatar = extractUrlFromBackground($('#add-contact-modal .form-avatar-placeholder').style.backgroundImage) || '';
                if (editingContactId) {
                    const c = state.contacts.find(x => x.id === editingContactId); if (c) { c.name = name; c.prompt = prompt; c.avatar = avatar; }
                    if (currentChatContactId === editingContactId) {$('#chat-title').textContent = name; originalChatTitle = name; }
                } else { const id = Date.now().toString(); state.contacts.push({ id, name, prompt, avatar }); state.chats[id] = []; }
                if(await saveState()) rerenderUI(); 
                closeModal($('#add-contact-modal'));
            });
            $('#save-user-settings-btn').addEventListener('click', async () => { 
                state.userProfile.name = $('#user-name').value.trim();
                state.userProfile.prompt = $('#user-prompt').value.trim();
                if(await saveState()) rerenderUI(); 
                closeModal($('#user-settings-modal'));
            });
            $('#save-user-display-btn').addEventListener('click', async () => { 
                 state.userDisplay.name = $('#display-user-name').value.trim() || state.userDisplay.name;
                 state.userDisplay.prompt = $('#display-user-prompt').value.trim();
                 if(await saveState()) rerenderUI(); 
                 closeModal($('#user-display-modal'));
            });
            $('#save-api-btn').addEventListener('click', async () => { 
                state.apiConfig.proxyUrl = $('#proxy-url').value.trim();
                state.apiConfig.apiKey = $('#api-key').value.trim();
                state.apiConfig.model = $('#model-name').value.trim();
                if(await saveState()) alert('API设置已保存'); 
                closeModal($('#api-settings-modal'));
            });

            $('#clear-chat-btn').addEventListener('click', async () => { 
                if (currentChatContactId && confirm('确定要清除与此角色的所有聊天记录吗？此操作不可逆！')) { 
                    state.chats[currentChatContactId] = []; 
                    await saveState(); 
                    $('#chat-messages').innerHTML = ''; 
                    renderMessageList(); 
                }
            });
             $('#export-chat-btn').addEventListener('click', () => { /* no changes */ });
             
             $('#fetch-models-btn').addEventListener('click', async () => {
                const proxyUrl = $('#proxy-url').value.trim().replace(/\/$/, ''); 
                const apiKey = $('#api-key').value.trim();
                const modelSelect = $('#model-name');

                if (!proxyUrl) {
                    alert('请先输入反代地址');
                    return;
                }

                const fetchUrl = `${proxyUrl}/v1/models`; 
                const btn = $('#fetch-models-btn');
                const originalBtnText = btn.textContent;
                btn.textContent = '拉取中...';
                btn.disabled = true;

                try {
                    const response = await fetch(fetchUrl, {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`API 请求失败: ${response.status} ${response.statusText}`);
                    }

                    const json = await response.json();
                    const models = json.data || (Array.isArray(json) ? json : []);
                    
                    if (models.length === 0) {
                        alert('未从API返回中找到模型列表。');
                        modelSelect.innerHTML = '<option>未找到模型</option>';
                        return;
                    }

                    const modelIds = models.map(m => m.id).filter(Boolean);

                    if (modelIds.length === 0) {
                        alert('API返回了数据，但没有找到有效的模型ID。');
                        modelSelect.innerHTML = '<option>无有效模型</option>';
                        return;
                    }

                    modelSelect.innerHTML = ''; 
                    modelIds.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        modelSelect.appendChild(option);
                    });

                    if (state.apiConfig.model && modelIds.includes(state.apiConfig.model)) {
                        modelSelect.value = state.apiConfig.model;
                    }
                    alert('模型列表拉取成功！');

                } catch (err) {
                    console.error('拉取模型失败:', err);
                    alert(`拉取模型失败: ${err.message}。\n请检查反代地址和API密钥是否正确。`);
                    modelSelect.innerHTML = '<option>拉取失败</option>';
                } finally {
                    btn.textContent = originalBtnText;
                    btn.disabled = false;
                }
             });
        }


        // 补全所有函数定义...
        renderContacts = function() {
            const list = $('#contact-list'); list.innerHTML = '';
            state.contacts.forEach(contact => {
                const li = document.createElement('li'); li.className = 'contact-item'; li.dataset.contactId = contact.id;
                li.innerHTML = `<div class="avatar-display" style="background-image: url('${escapeHtml(contact.avatar || '')}')"></div><div class="details"><div style="font-weight:600">${escapeHtml(contact.name)}</div></div>`;
                li.addEventListener('click', () => openChat(contact.id)); list.appendChild(li);
            });
        }
        renderMessageList = function() {
            const list = $('#message-list'); list.innerHTML = '';
            const contactsWithMessages = state.contacts.filter(c => state.chats[c.id]?.length > 0) .sort((a,b) => (state.chats[b.id].at(-1)?.timestamp || 0) - (state.chats[a.id].at(-1)?.timestamp || 0));
            contactsWithMessages.forEach(contact => {
                const lastMsg = state.chats[contact.id].at(-1);if(!lastMsg) return;
                const lastMessageText = (lastMsg.type === 'sticker') ? `[${lastMsg.desc || '表情'}]` : (lastMsg.type === 'error' ? '[错误]' : lastMsg.text);
                const senderPrefix = lastMsg.sender === 'user' ? '你: ' : '';
                const li = document.createElement('li'); li.className = 'message-item'; li.dataset.contactId = contact.id;
                li.innerHTML = `<div class="avatar-display" style="background-image: url('${escapeHtml(contact.avatar || '')}')"></div><div class="details"><div style="font-weight:700">${escapeHtml(contact.name)}</div><div class="last-message">${escapeHtml(senderPrefix + lastMessageText)}</div></div>`;
                li.addEventListener('click', () => openChat(contact.id)); list.appendChild(li);
            });
            updateEmptyStates();
        };
        prepareAddContactModal = function() { 
            const avatarElem = $('#add-contact-modal .form-avatar-placeholder');
            if (editingContactId) {
                $('#contact-modal-title').textContent = '修改角色设定'; $('#save-contact-btn').textContent = '保存修改';
                const contact = state.contacts.find(c => c.id === editingContactId);
                if (contact) { avatarElem.style.backgroundImage = contact.avatar ? `url("${contact.avatar}")` : ''; $('#contact-name').value = contact.name || ''; $('#contact-prompt').value = contact.prompt || ''; }
            } else {
                $('#contact-modal-title').textContent = '创建新角色'; $('#save-contact-btn').textContent = '保存角色';
                avatarElem.style.backgroundImage = ''; $('#contact-name').value = ''; $('#contact-prompt').value = '';
            }
        };
        prepareUserSettingsModal = function() { $('#user-settings-modal .form-avatar-placeholder').style.backgroundImage = state.userProfile.avatar ? `url("${state.userProfile.avatar}")` : ''; $('#user-name').value = state.userProfile.name; $('#user-prompt').value = state.userProfile.prompt; };
        prepareUserDisplayModal = function() { $('#user-display-modal .form-avatar-placeholder').style.backgroundImage = state.userDisplay.avatar ? `url("${state.userDisplay.avatar}")` : ''; $('#display-user-name').value = state.userDisplay.name; $('#display-user-prompt').value = state.userDisplay.prompt; };
        appendMessage = function(msg) { 
            const wrapper = document.createElement('div'); wrapper.className = `message-wrapper ${msg.sender === 'user' ? 'sent' : 'received'}`;
            let avatarUrl = '';
            if (msg.sender === 'user') { avatarUrl = state.userDisplay.avatar || state.userProfile.avatar || ''; } else { const contact = state.contacts.find(c => c.id === currentChatContactId); avatarUrl = contact?.avatar || ''; }
            const avatarHTML = `<div class="message-avatar" style="background-image: url('${escapeHtml(avatarUrl)}')"></div>`;
            const bubbleHTML = msg.type === 'sticker' ? `<div class="message-bubble sticker"><img src="${escapeHtml(msg.text)}" alt="${escapeHtml(msg.desc)}"></div>` : `<div class="message-bubble ${msg.type === 'error' ? 'error' : ''}">${escapeHtml(msg.text)}</div>`;
            wrapper.innerHTML = avatarHTML + bubbleHTML;
            const chatMessages = $('#chat-messages'); chatMessages.appendChild(wrapper);
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'end' });
        };
        switchPage = function(pageId) { 
            $$('.page.active').forEach(p => p.classList.remove('active')); $('#' + pageId)?.classList.add('active');
            $$('.nav-item.active').forEach(i => i.classList.remove('active')); $(`.nav-item[data-page="${pageId}"]`)?.classList.add('active');
            $('#add-contact-btn').style.display = pageId === 'contacts-page' ? 'block' : 'none';
            $('#header-title').textContent = { 'messages-page': '消息', 'contacts-page': '联系人', 'settings-page': '设置' }[pageId] || '消息';
         };
        openChat = function(contactId) { 
            currentChatContactId = contactId; const contact = state.contacts.find(c => c.id === contactId); if (!contact) return;
            originalChatTitle = contact.name; $('#chat-title').textContent = originalChatTitle; isGenerating = false;
            $('#chat-title').classList.remove('typing'); $('#chat-messages').innerHTML = '';
            (state.chats[contactId] || []).forEach(appendMessage);
            $('#main-content').style.display = 'none'; $('#chat-window').style.display = 'flex';
            $('#more-options-page').classList.remove('active');
            setTimeout(() => { const last = $('#chat-messages').lastElementChild; if(last) last.scrollIntoView({ behavior: "auto", block: 'end' }); }, 50);
        };
        
        // --- ⬇⬇⬇ 已修改 (实现AI回复逻辑) ⬇⬇⬇ ---
        const triggerAiReply = async () => { 
            if (!currentChatContactId || isGenerating) return; 
            isGenerating = true;
            const chatTitleEl = $('#chat-title'); 
            originalChatTitle = originalChatTitle || chatTitleEl.textContent;
            chatTitleEl.textContent = '正在输入中...'; 
            chatTitleEl.classList.add('typing'); 
            $('#ai-reply-btn').disabled = true;
            
            try { 
                const { proxyUrl, apiKey, model } = state.apiConfig;
                const contact = state.contacts.find(c => c.id === currentChatContactId);

                if (!proxyUrl || !apiKey || !model || model === '请先拉取模型') {
                    throw new Error('API设置不完整。请在设置中配置反代地址、API密钥并选择一个模型。');
                }
                if (!contact) {
                    throw new Error('未找到当前聊天角色。');
                }

                // 1. 准备消息
                const messages = [];

                // 2. 添加角色设定
                if (contact.prompt) {
                    messages.push({ role: 'system', content: contact.prompt });
                }
                
                // 3. 添加用户设定
                if (state.userProfile.prompt) {
                    messages.push({ role: 'user', content: `[My user profile: ${state.userProfile.prompt}]` });
                }

                // --- ⬇⬇⬇ 已修改 (修复表情包读取) ⬇⬇⬇ ---
                // 4. 添加聊天记录
                const history = state.chats[currentChatContactId]
                    .filter(msg => 
                        (msg.sender === 'user' && (msg.type === 'text' || msg.type === 'sticker')) || // 用户文本或表情
                        (msg.sender === 'assistant' && msg.type === 'text') // AI的文本回复
                    )
                    .map(msg => {
                        if (msg.sender === 'user') {
                            if (msg.type === 'sticker') {
                                // AI "读取" 表情的描述
                                return { role: 'user', content: `[用户发送了表情: ${msg.desc || '表情'}]` };
                            }
                            return { role: 'user', content: msg.text };
                        } else {
                            // 助理的回复
                            return { role: 'assistant', content: msg.text };
                        }
                    });
                // --- ⬆⬆⬆ 已修改 ⬆⬆⬆ ---
                
                messages.push(...history);

                // 5. 发起 API 请求
                const fetchUrl = `${proxyUrl.replace(/\/$/, '')}/v1/chat/completions`;
                
                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API 请求失败: ${response.status} ${response.statusText}. ${errorText}`);
                }

                const json = await response.json();
                const aiMessageContent = json.choices?.[0]?.message?.content?.trim();

                // --- ⬇⬇⬇ 已修改 (拆分回复) ⬇⬇⬇ ---
                // 6. 使用新函数接收消息 (并拆分)
                if (!aiMessageContent) {
                    throw new Error('AI未返回有效消息。');
                }

                // 按换行符拆分为多条消息
                const replyParts = aiMessageContent.split('\n').filter(part => part.trim().length > 0);

                if (replyParts.length > 1) {
                    // 如果有多条回复，逐条发送
                    for (const part of replyParts) {
                        await receiveChatMessage(part.trim());
                        // 模拟打字延迟
                        await delay(Math.random() * 800 + 400); 
                    }
                } else {
                    // 只有一条，或没有换行，直接发送
                    await receiveChatMessage(aiMessageContent);
                }
                // --- ⬆⬆⬆ 已修改 ⬆⬆⬆ ---

            } catch (err) { 
                console.error("AI 回复失败", err);
                // 7. 在聊天窗口中显示错误
                await receiveChatMessage(`[AI 回复出错: ${err.message}]`, 'error');
            }
            finally { 
                isGenerating = false; 
                chatTitleEl.textContent = originalChatTitle; 
                chatTitleEl.classList.remove('typing'); 
                $('#ai-reply-btn').disabled = false; 
                renderMessageList(); // 确保更新 "最后消息"
            }
        }
        // --- ⬆⬆⬆ 已修改 ⬆⬆⬆ ---

        function rerenderUI() {
            const userAvatarUrl = state.userDisplay.avatar || state.userProfile.avatar || '';
            $('#settings-nickname-display').textContent = state.userDisplay.name || '我的昵称';
            $('#user-avatar-display').style.backgroundImage = `url("${userAvatarUrl}")`;
            renderContacts(); renderMessageList();
        }

        // 初始化
        setupEventListeners();
        await loadState(); 

        window.__AI_CHAT_APP__ = { getState: () => state, save: saveState, clear: () => localforage.removeItem(VERSION) }; 
    });
    </script>
</body>
</html>
